<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Office Environmental Control</title>
    <!-- 1. Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Add custom text-shadow utility for neon glow effect
        tailwind.config = {
            theme: {
                extend: {
                    textShadow: {
                        'cyan': '0 0 8px rgba(0, 255, 255, 0.7)',
                        'fuchsia': '0 0 8px rgba(217, 70, 239, 0.7)',
                    },
                    boxShadow: {
                        'cyan-glow': '0 0 15px rgba(0, 255, 255, 0.5), 0 0 20px rgba(0, 255, 255, 0.3) inset',
                        'fuchsia-glow': '0 0 15px rgba(217, 70, 239, 0.5), 0 0 20px rgba(217, 70, 239, 0.3) inset',
                    }
                }
            }
        }
    </script>
    <!-- 2. React Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- 3. Babel to transpile JSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Share Tech Mono', monospace;
            background-color: #0a0a0a;
            background-image: 
                linear-gradient(rgba(13, 110, 253, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(13, 110, 253, 0.1) 1px, transparent 1px);
            background-size: 2rem 2rem;
            background-position: -1px -1px;
        }
    </style>
</head>
<body class="text-gray-200">
    <div id="root"></div>

    <script type="text/babel">
        const API_BASE_URL = 'http://127.0.0.1:5000';

        // --- Main App Component ---
        const App = () => {
            const [status, setStatus] = React.useState(null);
            const [loading, setLoading] = React.useState(true);
            const [error, setError] = React.useState(null);
            const [tempInput, setTempInput] = React.useState("");

            const fetchStatus = async () => {
                try {
                    const response = await fetch(`${API_BASE_URL}/status`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    setStatus(data);
                    if (document.activeElement.id !== 'temp-input') {
                        setTempInput(data.temperature);
                    }
                    setError(null); // Clear previous errors on successful fetch
                } catch (e) {
                    setError(`Failed to fetch status. Is the backend server running at ${API_BASE_URL}?`);
                    console.error(e);
                } finally {
                    setLoading(false);
                }
            };

            React.useEffect(() => {
                fetchStatus();
                // Poll for status updates every 5 seconds
                const interval = setInterval(fetchStatus, 5000);
                return () => clearInterval(interval);
            }, []);

            const sendControlCommand = async (action, value) => {
                try {
                    setError(null); // Clear previous errors
                    const response = await fetch(`${API_BASE_URL}/control`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ action, value }),
                    });
                    if (!response.ok) {
                        const errData = await response.json();
                        throw new Error(errData.error || 'Control command failed');
                    }
                    // Refresh status immediately after a successful command
                    await fetchStatus();
                } catch (e) {
                    setError(e.message);
                    console.error(e);
                }
            };

            const handleSetTemperature = () => {
                const temp = parseInt(tempInput, 10);
                if (!isNaN(temp)) {
                    sendControlCommand('set_temperature', temp);
                }
            };

            if (loading) {
                return <div className="text-center p-10">Loading...</div>;
            }

            return (
                <div className="container mx-auto p-4 md:p-8 max-w-3xl">
                    <div className="bg-black bg-opacity-50 backdrop-blur-xl rounded-2xl border border-cyan-500/50 shadow-cyan-glow p-6 md:p-8">
                        <h1 className="text-4xl md:text-5xl font-bold text-cyan-400 mb-8 text-center" style={{textShadow: '0 0 8px rgba(0,255,255,0.7)'}}>Office Control Panel</h1>
                        
                        {error && <div className="bg-red-900/50 border border-red-500 text-red-300 px-4 py-3 rounded-lg relative mb-4" role="alert">{error}</div>}

                        {/* Current Status Section */}
                        {status && (
                            <div className="mb-8 p-6 bg-black/30 rounded-xl border border-fuchsia-500/50 shadow-fuchsia-glow">
                                <h2 className="text-3xl font-semibold text-fuchsia-400 mb-4" style={{textShadow: '0 0 8px rgba(217,70,239,0.7)'}}>System Status</h2>
                                <div className="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
                                    <div>
                                        <p className="text-lg text-gray-400">Temperature</p>
                                        <p className="text-3xl font-bold text-cyan-300">{status.temperature}Â°C</p>
                                    </div>
                                    <div>
                                        <p className="text-lg text-gray-400">HVAC</p>
                                        <p className="text-3xl font-bold text-cyan-300 capitalize">{status.hvac_mode}</p>
                                    </div>
                                    <div>
                                        <p className="text-lg text-gray-400">Lights</p>
                                        <p className="text-3xl font-bold text-cyan-300">{status.lights_on ? 'On' : 'Off'}</p>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Controls Section */}
                        <div>
                            <h2 className="text-3xl font-semibold text-fuchsia-400 mb-4" style={{textShadow: '0 0 8px rgba(217,70,239,0.7)'}}>Manual Override</h2>
                            <div className="space-y-6">
                                {/* Temperature Control */}
                                <div className="flex items-center space-x-4">
                                    <label htmlFor="temp-input" className="font-medium text-gray-300 w-32 text-lg">Temperature:</label>
                                    <input
                                        id="temp-input"
                                        type="number"
                                        value={tempInput}
                                        onChange={(e) => setTempInput(e.target.value)}
                                        className="flex-grow p-2 bg-gray-900/50 border-2 border-gray-600 rounded-md focus:border-cyan-400 focus:ring-0 focus:outline-none text-white text-lg"
                                    />
                                    <button onClick={handleSetTemperature} className="bg-transparent border-2 border-cyan-400 text-cyan-400 font-bold py-2 px-4 rounded-md transition-all duration-300 hover:bg-cyan-400 hover:text-black hover:shadow-[0_0_15px_rgba(0,255,255,0.8)]">
                                        Set
                                    </button>
                                </div>

                                {/* HVAC Control */}
                                <div className="flex items-center space-x-4">
                                    <label className="font-medium text-gray-300 w-32 text-lg">HVAC Mode:</label>
                                    <div className="flex-grow grid grid-cols-3 gap-2">
                                        <button onClick={() => sendControlCommand('set_hvac_mode', 'heat')} className={`py-2 px-4 rounded-md transition-all duration-300 ${status?.hvac_mode === 'heat' ? 'bg-red-500 text-white shadow-[0_0_10px_#ef4444]' : 'bg-gray-700/50 hover:bg-gray-600/80'}`}>
                                            Heat
                                        </button>
                                        <button onClick={() => sendControlCommand('set_hvac_mode', 'cool')} className={`py-2 px-4 rounded-md transition-all duration-300 ${status?.hvac_mode === 'cool' ? 'bg-cyan-400 text-black shadow-[0_0_10px_#22d3ee]' : 'bg-gray-700/50 hover:bg-gray-600/80'}`}>
                                            Cool
                                        </button>
                                        <button onClick={() => sendControlCommand('set_hvac_mode', 'off')} className={`py-2 px-4 rounded-md transition-all duration-300 ${status?.hvac_mode === 'off' ? 'bg-gray-600 text-white' : 'bg-gray-700/50 hover:bg-gray-600/80'}`}>
                                            Off
                                        </button>
                                    </div>
                                </div>

                                {/* Lights Control */}
                                <div className="flex items-center space-x-4">
                                    <label className="font-medium text-gray-300 w-32 text-lg">Lighting:</label>
                                    <div className="flex-grow grid grid-cols-2 gap-2">
                                        <button onClick={() => sendControlCommand('set_lights', 'on')} className={`py-2 px-4 rounded-md transition-all duration-300 ${status?.lights_on ? 'bg-yellow-300 text-black shadow-[0_0_10px_#fde047]' : 'bg-gray-700/50 hover:bg-gray-600/80'}`}>
                                            On
                                        </button>
                                        <button onClick={() => sendControlCommand('set_lights', 'off')} className={`py-2 px-4 rounded-md transition-all duration-300 ${!status?.lights_on ? 'bg-gray-600 text-white' : 'bg-gray-700/50 hover:bg-gray-600/80'}`}>
                                            Off
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
